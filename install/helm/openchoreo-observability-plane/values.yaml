# Global values shared across all components
global:
  commonLabels: {}
  # standard → multi-node ClickStack, minimal → single replica footprint
  installationMode: standard

# ClickStack (ClickHouse + ingestion service)
clickstack:
  enabled: true
  image:
    repository: clickhouse/clickhouse-server
    tag: "24.6"
    pullPolicy: IfNotPresent
  replicas:
    standard: 3
    minimal: 1
  resources:
    limits:
      cpu: 2000m
      memory: 6Gi
    requests:
      cpu: 500m
      memory: 2Gi
  storage:
    size: 200Gi
    minimalSize: 50Gi
    storageClass: ""
  service:
    port: 9000
    annotations: {}
  credentials:
    username: clickstack_admin
    password: ThisIsTheClickStackPassword1
  tls:
    enabled: false
    secretName: ""
  initSQL:
    enabled: true
    schema: |
      SET allow_experimental_object_type = 1;
      CREATE DATABASE IF NOT EXISTS telemetry;
      CREATE TABLE IF NOT EXISTS telemetry.logs_mv (
        organization_id String,
        project_id String,
        component_id String,
        environment_id String,
        version String,
        version_id String,
        build_id String,
        build_uuid String,
        gateway_vhost String,
        api_id String,
        api_version String,
        namespace String,
        pod_id String,
        container_name String,
        log_type String,
        log String,
        log_level String,
        labels_json String,
        timestamp DateTime64(9)
      ) ENGINE = MergeTree()
      ORDER BY (organization_id, project_id, component_id, timestamp);
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS build_id String DEFAULT '' AFTER version_id;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS build_uuid String DEFAULT '' AFTER build_id;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS gateway_vhost String DEFAULT '' AFTER build_uuid;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS api_id String DEFAULT '' AFTER gateway_vhost;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS api_version String DEFAULT '' AFTER api_id;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS log String DEFAULT '' AFTER log_type;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS log_level String DEFAULT '' AFTER log;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS labels_json String AFTER log_level;
      ALTER TABLE telemetry.logs_mv ADD COLUMN IF NOT EXISTS timestamp DateTime64(9) DEFAULT now64(9) AFTER labels_json;
      DROP VIEW IF EXISTS telemetry.logs_mv_ingest;
      CREATE MATERIALIZED VIEW telemetry.logs_mv_ingest TO telemetry.logs_mv AS
      SELECT
        coalesce(ResourceAttributes['organization.id'], '') AS organization_id,
        coalesce(ResourceAttributes['project.id'], '') AS project_id,
        coalesce(ResourceAttributes['component.id'], '') AS component_id,
        coalesce(ResourceAttributes['environment.id'], '') AS environment_id,
        coalesce(ResourceAttributes['version'], '') AS version,
        coalesce(ResourceAttributes['version.id'], '') AS version_id,
        coalesce(ResourceAttributes['build.id'], '') AS build_id,
        coalesce(ResourceAttributes['build.uuid'], '') AS build_uuid,
        coalesce(LogAttributes['gateway_vhost'], '') AS gateway_vhost,
        coalesce(LogAttributes['api_id'], '') AS api_id,
        coalesce(LogAttributes['api_version'], '') AS api_version,
        coalesce(LogAttributes['namespace'], '') AS namespace,
        coalesce(LogAttributes['pod_id'], '') AS pod_id,
        coalesce(LogAttributes['container_name'], coalesce(LogAttributes['container'], '')) AS container_name,
        coalesce(LogAttributes['log_type'], '') AS log_type,
        Body AS log,
        SeverityText AS log_level,
        toJSONString(LogAttributes) AS labels_json,
        Timestamp AS timestamp
      FROM telemetry.otel_logs;

# OTLP gateway pushes traces/metrics/logs into ClickStack
gateway:
  enabled: true
  image:
    repository: otel/opentelemetry-collector-contrib
    tag: "0.103.0"
    pullPolicy: IfNotPresent
  replicas: 1
  service:
    otlpGrpcPort: 4317
    otlpHttpPort: 4318
  extraLabels: {}
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 256Mi
  config:
    exporters:
      clickhouse:
        endpoint: "clickstack:9000"
        database: telemetry
        username: "${env:CLICKSTACK_USERNAME}"
        password: "${env:CLICKSTACK_PASSWORD}"
    processors:
      batch: {}
      memory_limiter:
        check_interval: 5s
        limit_mib: 400
    receivers:
      otlp:
        protocols:
          grpc:
          http:
            cors:
              allowed_origins:
                - "*"
    service:
      telemetry:
        logs:
          level: info
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [clickhouse]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [clickhouse]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [clickhouse]

# HyperDX UI deployment
hyperdx:
  enabled: true
  image:
    repository: hyperdx/hyperdx
    tag: "latest"
    pullPolicy: IfNotPresent
  replicas: 1
  service:
    type: ClusterIP
    port: 3000
  env:
    CLICKHOUSE_HOST: clickstack
    CLICKHOUSE_PORT: "9000"
    CLICKHOUSE_DATABASE: telemetry
    # Optional: set to a real API key to enable HyperDX-managed OpenTelemetry without warnings
    HYPERDX_API_KEY: ""
  signing:
    key: ""
    ttl: 15m
    baseUrl: http://hyperdx:3000
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 256Mi

# Observer service configuration
observer:
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/observer
    tag: ""  # defaults to Chart.AppVersion
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 8080
  logLevel: info
  telemetry:
    backend: clickstack
    dualRead: true
    dualSampleRate: 0.05
  clickstack:
    hosts:
      - clickstack:9000
    database: telemetry
  openSearch:
    address: http://opensearch:9200
    username: admin
    password: ThisIsTheOpenSearchPassword1
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Node-level OpenTelemetry collectors (data plane)
collectors:
  enabled: true
  image:
    repository: otel/opentelemetry-collector-contrib
    tag: "0.103.0"
    pullPolicy: IfNotPresent
  serviceAccount:
    create: true
    name: ""
  nodeSelector: {}
  tolerations:
    - operator: Exists
      effect: NoSchedule
  otlp:
    endpoint: "http://otlp-gateway:4318"
    protocol: http
    compression: gzip
    tls:
      enabled: false
      secretName: ""
      caFile: ca.crt
      certFile: client.crt
      keyFile: client.key
  filelog:
    include:
      - /var/log/containers/*.log
    exclude:
      - /var/log/containers/*fluent-bit*.log
    startAt: end
  resources:
    limits:
      cpu: 250m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Monitoring (Grafana dashboards + Prometheus alerts)
monitoring:
  dashboards:
    enabled: true
  alerts:
    enabled: true
    ingestionLagSeconds: 3
    queryP95Seconds: 1
    minCompressionRatio: 10
  cost:
    storagePerTbUsd: 0.5
    queryPerSecondUsd: 0.0002

# Legacy OpenSearch toggles kept for dual-read fallback
openSearch:
  enabled: false

# Fluent Bit configuration (unchanged)
fluentBit:
  enabled: false
  config: {}
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Prometheus stack configuration (unchanged default)
prometheus:
  enabled: false

# Service Account configuration
serviceAccount:
  create: true
  name: ""
  annotations: {}

# Migration tooling configuration for OpenSearch → ClickStack
migration:
  # Container image for migration jobs
  image:
    repository: alpine/k8s
    tag: "1.28.7"
    pullPolicy: IfNotPresent

  # Shadow write enablement (dual-write to both OpenSearch and ClickStack)
  shadowWrite:
    enabled: false
    backoffLimit: 3

  # Validation job to verify dual-write consistency
  validation:
    enabled: false
    # How long to validate data consistency (seconds)
    durationSeconds: 3600
    # How often to sample and compare counts (seconds)
    sampleIntervalSeconds: 60
    # Maximum acceptable drift per sample (%)
    maxDriftPercent: 1.0
    # Maximum acceptable overall drift rate (%)
    maxOverallDriftPercent: 5.0
    backoffLimit: 5

  # OpenSearch cleanup job (removes legacy resources after migration)
  cleanup:
    enabled: false
    # Safety: require explicit confirmation flag
    requireExplicitFlag: true
    confirmed: false
    # Archive indices before deletion
    archiveIndices: true
    backupLocation: "/backup/opensearch"
    # What resources to delete
    deleteStatefulSet: true
    deletePVCs: false  # Keep PVCs for rollback window
    deleteServices: true
    deleteConfigMaps: true
    deleteSecrets: false  # Keep secrets for potential rollback
    backoffLimit: 2
