{{- if .Values.gateway.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otlp-gateway-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" (dict "context" . "component" "gateway") | nindent 4 }}
data:
  collector.yaml: |
{{- toYaml .Values.gateway.config | nindent 4 }}

---
apiVersion: v1
kind: Secret
metadata:
  name: otlp-gateway-clickstack
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" (dict "context" . "component" "gateway") | nindent 4 }}
type: Opaque
stringData:
  CLICKSTACK_USERNAME: {{ .Values.clickstack.credentials.username | default "clickstack_admin" | quote }}
  CLICKSTACK_PASSWORD: {{ .Values.clickstack.credentials.password | default "ThisIsTheClickStackPassword1" | quote }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otlp-gateway
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" (dict "context" . "component" "gateway") | nindent 4 }}
spec:
  replicas: {{ .Values.gateway.replicas | default 1 }}
  selector:
    matchLabels:
      {{- include "openchoreo-observability-plane.componentSelectorLabels" (dict "context" . "component" "gateway") | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "openchoreo-observability-plane.componentSelectorLabels" (dict "context" . "component" "gateway") | nindent 8 }}
        {{- with .Values.gateway.extraLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      containers:
        - name: collector
          image: "{{ .Values.gateway.image.repository }}:{{ .Values.gateway.image.tag }}"
          imagePullPolicy: {{ .Values.gateway.image.pullPolicy | default "IfNotPresent" }}
          args:
            - "--config=/conf/collector.yaml"
          envFrom:
            - secretRef:
                name: otlp-gateway-clickstack
          volumeMounts:
            - name: gateway-config
              mountPath: /conf
          ports:
            - containerPort: {{ .Values.gateway.service.otlpGrpcPort | default 4317 }}
              name: otlp-grpc
            - containerPort: {{ .Values.gateway.service.otlpHttpPort | default 4318 }}
              name: otlp-http
          resources:
            {{- if .Values.gateway.resources }}
            {{- toYaml .Values.gateway.resources | nindent 12 }}
            {{- end }}
      volumes:
        - name: gateway-config
          configMap:
            name: otlp-gateway-config

---
apiVersion: v1
kind: Service
metadata:
  name: otlp-gateway
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" (dict "context" . "component" "gateway") | nindent 4 }}
spec:
  type: ClusterIP
  selector:
    {{- include "openchoreo-observability-plane.componentSelectorLabels" (dict "context" . "component" "gateway") | nindent 4 }}
  ports:
    - name: otlp-grpc
      port: {{ .Values.gateway.service.otlpGrpcPort | default 4317 }}
      targetPort: otlp-grpc
      protocol: TCP
    - name: otlp-http
      port: {{ .Values.gateway.service.otlpHttpPort | default 4318 }}
      targetPort: otlp-http
      protocol: TCP
{{- end }}
