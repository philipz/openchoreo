{{- if .Values.collectors.enabled }}
{{- $fullname := include "openchoreo-observability-plane.fullname" . }}
{{- $defaultSA := printf "%s-collector" $fullname }}
{{- $saName := default $defaultSA .Values.collectors.serviceAccount.name }}
{{- $collectorLabels := dict "context" . "component" (printf "%s-collector" $fullname) }}
{{- if .Values.collectors.serviceAccount.create }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $saName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" $collectorLabels | nindent 4 }}
{{- end }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ $fullname }}-collector
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" $collectorLabels | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces", "nodes"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ $fullname }}-collector
subjects:
  - kind: ServiceAccount
    name: {{ $saName }}
    namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ $fullname }}-collector

{{- if .Values.collectors.otlp.tls.secretName }}
{{- /* TLS secret is expected to be provided by user; no template emitted */ -}}
{{- end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullname }}-collector-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" $collectorLabels | nindent 4 }}
data:
  collector.yaml: |
    receivers:
      filelog/containers:
        include:
{{- range .Values.collectors.filelog.include }}
          - {{ . | quote }}
{{- end }}
{{- if .Values.collectors.filelog.exclude }}
        exclude:
{{- range .Values.collectors.filelog.exclude }}
          - {{ . | quote }}
{{- end }}
{{- end }}
        start_at: {{ .Values.collectors.filelog.startAt | default "end" | quote }}
        include_file_name: false
        include_file_path: true
        operators:
          - type: move
            from: body
            to: attributes.log_raw
          - type: json_parser
            parse_from: attributes.log_raw
            if: 'attributes["log_raw"] matches "^\\s*{.*}\\s*$"'
          - type: move
            from: attributes.log
            to: body
            if: 'attributes["log"] != nil'
          - type: move
            from: attributes.message
            to: body
            if: 'attributes["log"] == nil and attributes["message"] != nil'
          - type: remove
            field: attributes.log_raw
          - type: remove
            field: attributes.log
      otlp:
        protocols:
          grpc:
          http:
    processors:
      memory_limiter:
        check_interval: 5s
        limit_mib: 400
        spike_limit_mib: 100
      batch:
        send_batch_size: 512
        timeout: 5s
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.name
              - from: resource_attribute
                name: k8s.namespace.name
          - sources:
              - from: attributes
                name: k8s.pod.name
              - from: attributes
                name: k8s.namespace.name
          - sources:
              - from: connection
        extract:
          metadata:
            - k8s.pod.name
            - k8s.namespace.name
            - k8s.pod.uid
            - k8s.node.name
          labels:
            - key: component-name
            - key: environment-name
            - key: project-name
            - key: organization-name
            - key: version
            - key: version_id
            - key: pipeline-id
            - key: workflow_name
            - key: build-name
            - key: uuid
            - key: target
      attributes/promote:
        actions:
          - action: upsert
            key: component.id
            from_attribute: component-name
          - action: upsert
            key: environment.id
            from_attribute: environment-name
          - action: upsert
            key: project.id
            from_attribute: project-name
          - action: upsert
            key: organization.id
            from_attribute: organization-name
    exporters:
      otlp{{ if eq (lower .Values.collectors.otlp.protocol) "grpc" }}{{ "" }}{{ else }}http{{ end }}/clickstack:
        endpoint: {{ .Values.collectors.otlp.endpoint | quote }}
{{- if eq (lower .Values.collectors.otlp.protocol) "grpc" }}
        tls:
{{- else }}
        compression: {{ .Values.collectors.otlp.compression | default "gzip" | quote }}
        tls:
{{- end }}
{{- if .Values.collectors.otlp.tls.enabled }}
          ca_file: /etc/otel/tls/{{ .Values.collectors.otlp.tls.caFile | default "ca.crt" }}
{{- if .Values.collectors.otlp.tls.certFile }}
          cert_file: /etc/otel/tls/{{ .Values.collectors.otlp.tls.certFile }}
{{- end }}
{{- if .Values.collectors.otlp.tls.keyFile }}
          key_file: /etc/otel/tls/{{ .Values.collectors.otlp.tls.keyFile }}
{{- end }}
          insecure: false
{{- else }}
          insecure: true
{{- end }}
        timeout: 30s
        retry_on_failure:
          enabled: true
          max_elapsed_time: 300s
        sending_queue:
          enabled: true
          num_consumers: 4
          queue_size: 5120
    service:
      telemetry:
        logs:
          level: info
      pipelines:
        logs/containers:
          receivers: [filelog/containers]
          processors: [memory_limiter, k8sattributes, attributes/promote, batch]
          exporters: [{{ if eq (lower .Values.collectors.otlp.protocol) "grpc" }}otlp/clickstack{{ else }}otlphttp/clickstack{{ end }}]
        logs/otlp:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, attributes/promote, batch]
          exporters: [{{ if eq (lower .Values.collectors.otlp.protocol) "grpc" }}otlp/clickstack{{ else }}otlphttp/clickstack{{ end }}]
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [{{ if eq (lower .Values.collectors.otlp.protocol) "grpc" }}otlp/clickstack{{ else }}otlphttp/clickstack{{ end }}]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [{{ if eq (lower .Values.collectors.otlp.protocol) "grpc" }}otlp/clickstack{{ else }}otlphttp/clickstack{{ end }}]

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ $fullname }}-collector
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.componentLabels" $collectorLabels | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "openchoreo-observability-plane.componentSelectorLabels" $collectorLabels | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "openchoreo-observability-plane.componentSelectorLabels" $collectorLabels | nindent 8 }}
    spec:
      serviceAccountName: {{ $saName }}
{{- if .Values.collectors.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.collectors.nodeSelector | indent 8 }}
{{- end }}
{{- if .Values.collectors.tolerations }}
      tolerations:
{{ toYaml .Values.collectors.tolerations | indent 8 }}
{{- end }}
      containers:
        - name: otel-collector
          image: "{{ .Values.collectors.image.repository }}:{{ .Values.collectors.image.tag }}"
          imagePullPolicy: {{ .Values.collectors.image.pullPolicy | default "IfNotPresent" }}
          args: ["--config=/conf/collector.yaml"]
          ports:
            - containerPort: 4317
              name: otlp-grpc
            - containerPort: 4318
              name: otlp-http
          env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: collector-config
              mountPath: /conf
            - name: varlogcontainers
              mountPath: /var/log/containers
              readOnly: true
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
            - name: dockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
{{- if and .Values.collectors.otlp.tls.enabled .Values.collectors.otlp.tls.secretName }}
            - name: collector-tls
              mountPath: /etc/otel/tls
              readOnly: true
{{- end }}
          resources:
            {{- if .Values.collectors.resources }}
            {{- toYaml .Values.collectors.resources | nindent 12 }}
            {{- end }}
      volumes:
        - name: collector-config
          configMap:
            name: {{ $fullname }}-collector-config
        - name: varlogcontainers
          hostPath:
            path: /var/log/containers
        - name: varlogpods
          hostPath:
            path: /var/log/pods
        - name: dockercontainers
          hostPath:
            path: /var/lib/docker/containers
{{- if and .Values.collectors.otlp.tls.enabled .Values.collectors.otlp.tls.secretName }}
        - name: collector-tls
          secret:
            secretName: {{ .Values.collectors.otlp.tls.secretName }}
            optional: true
{{- end }}
{{- end }}
