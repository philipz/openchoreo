apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
data:
  collector.yaml: |
    receivers:
      filelog/containers:
        include:
          - /var/log/containers/*.log
        exclude:
          - /var/log/containers/*fluent-bit*.log
        start_at: end
        include_file_name: false
        include_file_path: true
        operators:
          - type: move
            from: body
            to: attributes.log_raw
          - type: json_parser
            parse_from: attributes.log_raw
            if: 'attributes["log_raw"] matches "^\\s*{.*}\\s*$"'
          - type: move
            from: attributes.log
            to: body
            if: 'attributes["log"] != nil'
          - type: move
            from: attributes.message
            to: body
            if: 'attributes["log"] == nil and attributes["message"] != nil'
          - type: remove
            field: attributes.log_raw
          - type: remove
            field: attributes.log
      otlp:
        protocols:
          grpc:
          http:
    processors:
      memory_limiter:
        check_interval: 5s
        limit_mib: 400
        spike_limit_mib: 100
      batch:
        send_batch_size: 512
        timeout: 5s
      k8sattributes:
        auth_type: serviceAccount
        passthrough: false
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: resource_attribute
                name: k8s.pod.name
              - from: resource_attribute
                name: k8s.namespace.name
          - sources:
              - from: attributes
                name: k8s.pod.name
              - from: attributes
                name: k8s.namespace.name
          - sources:
              - from: connection
        extract:
          metadata:
            - k8s.pod.name
            - k8s.namespace.name
            - k8s.pod.uid
            - k8s.node.name
          labels:
            - key: component-name
            - key: environment-name
            - key: project-name
            - key: organization-name
            - key: version
            - key: version_id
            - key: pipeline-id
            - key: workflow_name
            - key: build-name
            - key: uuid
            - key: target
      attributes/promote:
        actions:
          - action: upsert
            key: component.id
            from_attribute: component-name
          - action: upsert
            key: environment.id
            from_attribute: environment-name
          - action: upsert
            key: project.id
            from_attribute: project-name
          - action: upsert
            key: organization.id
            from_attribute: organization-name
    exporters:
      otlphttp/clickstack:
        endpoint: http://otlp-gateway.openchoreo-observability-plane.svc.cluster.local:4318
        compression: gzip
        timeout: 30s
        retry_on_failure:
          enabled: true
          max_elapsed_time: 300s
        sending_queue:
          enabled: true
          num_consumers: 4
          queue_size: 5120
    service:
      telemetry:
        logs:
          level: info
      pipelines:
        logs/containers:
          receivers: [filelog/containers]
          processors: [memory_limiter, k8sattributes, attributes/promote, batch]
          exporters: [otlphttp/clickstack]
        logs/otlp:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, attributes/promote, batch]
          exporters: [otlphttp/clickstack]
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/clickstack]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlphttp/clickstack]
