{
  "id": "snapshot_1763131094785_n76yiojyr",
  "approvalId": "approval_1763131094756_i7n2xx4ff",
  "approvalTitle": "HyperDX enablement design",
  "version": 1,
  "timestamp": "2025-11-14T14:38:14.785Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本設計文件針對「HyperDX enablement」需求提出具體落地方案，目標是在 `install/helm/openchoreo-observability-plane` Helm chart、`hack/` 自動化腳本與 `docs/` 操作文件中，提供預設可執行的 ClickStack + HyperDX 體驗。依據 docs/DeepWiki/Observability.md 的管線描述，我們保留既有的 OTLP collector → ClickHouse → Observer 流程，再加入 HyperDX UI 與 MongoDB 狀態層，並對 Makefile/kind 腳本與文檔給出一致的使用者體驗。此設計同時參考《Helm | ClickStack Deployment》文件的建議：HyperDX chart 預設包含 ClickHouse、OTel collector 與 MongoDB，可用 values.yaml 覆蓋；我們將這些能力以 OpenChoreo 架構方式包裝，並讓 Greeter Service 等範例工作負載能在 HyperDX 看到 Logs/Traces。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- 保持 Go/Helm/YAML 的分層：Observer API (Go)、Helm chart (YAML)、Collectors (Kustomize) 各自獨立，符合「Plane Isolation」原則。\n- 全面支持 OpenTelemetry：HyperDX 仍透過 OTLP collector 與 ClickHouse 傳遞資料，契合「OpenTelemetry-first pipelines」。\n- 依據 tech.md 的安全要求，Mongo/ClickHouse 凭證使用 Kubernetes Secret，Helm values 僅提供覆寫入口。\n\n### Project Structure (structure.md)\n- 觀察面 Helm chart 維持在 `install/helm/openchoreo-observability-plane`，並透過 `_helpers.tpl` 共用 labels，符合「Declarative Config」原則。\n- Kind/Helm automation 仍透過 `hack/deploy-clickstack-kind.sh` + `make kind.deploy-observability-plane`，與現行 `install/dev/kind.sh`、`make/kind.mk` 的組織一致。\n- 新增的文檔（例如 `docs/observability/clickstack.md`）遵循 docs 目錄規則，並與 DeepWiki 互補。\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **OpenChoreo Observability Plane Helm chart (`install/helm/openchoreo-observability-plane`)**：沿用既有 ClickStack、Observer、Gateway 模組，擴寫 `values.yaml` 與 `templates/hyperdx-*.yaml`。\n- **OTLP Collector Kustomize (`config/observability/collectors/otel/base`)**：延續 logs pipeline，並於 ConfigMap 中加入 traces/metrics pipeline 及 HyperDX-friendly metadata。\n- **Automation (`hack/deploy-clickstack-kind.sh`, `Makefile` target)**：維持 ensure_cilium + helm upgrade 流程，僅加入 HyperDX/Mongo 參數與輸出訊息。\n- **Docs (`docs/observability-logging.md`, DeepWiki)**：新的 HyperDX 指南將引用現有章節，避免重複描述。\n\n### Integration Points\n- **Observer service**：`templates/observer/observer-deployment.yaml` 已有 `observer.telemetry.backend`，設計將確保 HyperDX-only 模式不再存取 OpenSearch。\n- **ClickStack ClickHouse cluster**：使用 `clickstack-credentials` Secret 與 `gateway.config.exporters.clickhouse.endpoint`，HyperDX 直接共享此 ClickHouse。\n- **MongoDB**：HyperDX chart 需要 Mongo 儲存 Alert/Setting；我們將透過 Bitnami `mongodb` 子 chart 或 Kubernetes StatefulSet，並在 `hyperdx.extraEnv` 內注入 `MONGODB_URI`。\n- **HyperDX UI**：服務以 ClusterIP 暴露，使用者藉由 `kubectl port-forward svc/hyperdx 8080:3000` 存取。\n\n## Architecture\n\n整體架構沿用 ClickStack Observability Plane，新增 HyperDX 與 Mongo 服務，並對 Otel collector 與 Observer 做少量調整：\n\n```mermaid\nflowchart TD\n    subgraph Kind/Cluster\n        subgraph DataPlane\n            AppPods[Greeter / Projects]\n            FluentBit[Fluent Bit]\n            OtelDS[OTel Collector DS]\n        end\n        subgraph ObservabilityPlane\n            Gateway[OTLP Gateway]\n            ClickHouse[(ClickStack ClickHouse)]\n            Mongo[(MongoDB for HyperDX)]\n            HyperDXUI[HyperDX Deployment]\n            Observer[Observer API]\n        end\n    end\n\n    AppPods --> FluentBit --> OtelDS --> Gateway --> ClickHouse\n    OtelDS --> Gateway\n    HyperDXUI -->|SQL/HTTP| ClickHouse\n    HyperDXUI -->|Mongo URI| Mongo\n    Observer -->|ClickStack driver| ClickHouse\n```\n\n模組化原則：\n1. **Helm values** 控制是否啟用 HyperDX/Mongo，以及 ClickHouse/Mongo 連線覆寫。\n2. **Collector** 只專注於 OTLP ingest，不需知道 HyperDX。\n3. **Observer** 透過環境變數決定僅使用 ClickStack，避免探測 OpenSearch。\n4. **Docs + Scripts** 組合出一鍵部署體驗，並清楚說明如何在 HyperDX 中驗證 telemetry。\n\n## Components and Interfaces\n\n### Component 1 — HyperDX Helm 模組\n- **Purpose**：以 `templates/hyperdx-deployment.yaml` 與 `values.yaml` 控制 Deployment + Service，支援 `hyperdx.extraEnv`、`hyperdx.signing.*` 等設定。\n- **Interfaces**：`helm upgrade` 時可透過 `--set hyperdx.enabled=true`, `hyperdx.mongodb.uri`, `hyperdx.clickhouse.*` 等參數覆寫；Kubernetes Service `hyperdx:3000` 提供 UI。\n- **Dependencies**：`clickstack-credentials` Secret、Mongo URI、OTLP Gateway endpoint。\n- **Reuses**：沿用 chart helper labels、Secrets 與 gateway exporter 設定。\n\n### Component 2 — MongoDB 附屬服務\n- **Purpose**：為 HyperDX 提供 stateful backend。可選擇 Bitnami 子 chart (`hyperdx.mongodb.enabled=true`) 或簡化版 StatefulSet（僅在 KinD 使用）。\n- **Interfaces**：`hyperdx.mongodb` values 定義 storageClass、persistence、auth；生成 `Secret/hyperdx-mongodb` 並透過 `hyperdx.extraEnv` 暴露 `MONGODB_URI`/`MONGODB_PASSWORD`。\n- **Dependencies**：Kubernetes StorageClass (KinD 預設使用 hostPath)、`kubectl` 權限。\n- **Reuses**：Makefile/kind script 會檢查並輸出 Mongo 連線資訊供 UI 設定。\n\n### Component 3 — Observer 與 Collector 調整\n- **Purpose**：確保 ClickStack-only 模式穩定；collector 保留 Kubernetes metadata enrichment 以配合 HyperDX 查詢。\n- **Interfaces**：`observer.telemetry.backend=clickstack`、`observer.telemetry.dualRead=false`；collector ConfigMap `collector.yaml` 新增 traces/metrics pipeline，以及 `pod_association` 以回寫 `resource.k8s.*` 屬性。\n- **Dependencies**：OTLP Gateway (Envoy proxy) 與 ClickHouse exporter。\n- **Reuses**：`config/observability/collectors/otel/base/collector-configmap.yaml` 既有 processors (k8sattributes、attributes/promote)。\n\n### Component 4 — 自動化腳本與文件\n- **Purpose**：讓使用者透過 `make kind.deploy-observability-plane` 自動安裝 Cilium → Helm chart → 驗證 HyperDX。\n- **Interfaces**：環境變數 `HYPERDX_ENABLED`, `CLICKSTACK_PASSWORD`, `MONGODB_STORAGE` 等；腳本輸出 HyperDX endpoint、port-forward 指令與 Greeter verification 步驟。\n- **Dependencies**：`hack/deploy-clickstack-kind.sh`, Makefile target, docs/observability 指南。\n- **Reuses**：`install/dev/kind.sh` 既有 CNI/kube-proxy 停用邏輯，以及 DeepWiki/Quick Start 流程。\n\n## Data Models\n\n### HyperDX Helm Values 結構\n```\nhyperdx:\n  enabled: true\n  image:\n    repository: hyperdx/hyperdx\n    tag: v2.0.0\n  service:\n    type: ClusterIP\n    port: 3000\n  env:\n    CLICKHOUSE_HOST: clickstack\n    CLICKHOUSE_PORT: \"9000\"\n    CLICKHOUSE_DATABASE: telemetry\n  extraEnv:\n    MONGODB_URI: mongodb://hyperdx:$(HYPERDX_MONGODB_PASSWORD)@hyperdx-mongodb:27017/hyperdx\n    OTLP_GATEWAY: http://otlp-gateway:4318\n  signing:\n    key: $(HYPERDX_SIGNING_KEY)\n    ttl: 15m\n    baseUrl: http://hyperdx:3000\n  mongodb:\n    enabled: true\n    persistence:\n      size: 10Gi\n```\n\n### Secrets 與 ConfigMap\n```\napiVersion: v1\nkind: Secret\nmetadata:\n  name: hyperdx-mongodb\nstringData:\n  uri: mongodb://hyperdx:${password}@hyperdx-mongodb:27017/hyperdx\n  password: ${password}\n\ndata:\n  collector.yaml: |\n    exporters:\n      otlphttp/clickstack:\n        endpoint: http://otlp-gateway:4318\n    service:\n      pipelines:\n        traces:\n          receivers: [otlp]\n          processors: [memory_limiter, k8sattributes, attributes/promote, batch]\n          exporters: [otlphttp/clickstack]\n```\n\n## Error Handling\n\n1. **ClickHouse/OTLP 未就緒**\n   - **Handling**：Helm pre-install hook檢查 `clickstack` StatefulSet/Service；HyperDX Deployment `initContainers` 以 `nc -z` 等待 9000/4318 開通。\n   - **User Impact**：`kubectl get pods` 會看到 HyperDX Pod Pending，文件指引用 `kubectl logs hyperdx -c init` 確認。\n\n2. **MongoDB 無法啟動或憑證錯誤**\n   - **Handling**：StatefulSet 透過 readinessProbe 與 PVC 狀態擋住 Helm `--wait`；HyperDX 以 `MONGODB_URI` 連線失敗時輸出清楚錯誤，腳本提示重新產生密碼。\n   - **User Impact**：Make target最終若檢測到 Pod 不 Ready，會列出 `kubectl describe sts/hyperdx-mongodb` 指令。\n\n3. **Observer 健康檢查仍連至 OpenSearch**\n   - **Handling**：將 `/health` 邏輯改為依 `observer.telemetry.backend` 判斷，如為 `clickstack` 則跳過 OpenSearch；Helm values 預設 `openSearch.enabled=false` 並移除 coreDNS 變更。\n   - **User Impact**：避免 CrashLoop 並讓 `@test/e2e` 成功。\n\n## Testing Strategy\n\n### Unit Testing\n- 為 Helm chart 新增 `tests/hyperdx_values_test.yaml` 以驗證 `hyperdx.enabled` with Mongo 開關與 Secret 參考。\n- Go 模組（observer 健康檢查等）撰寫對應 unit tests (`internal/observer/healthcheck_test.go`) 確保 backend switch 行為正確。\n\n### Integration Testing\n- 於 `install/helm/openchoreo-observability-plane/tests/test-migration.sh` 加入 HyperDX + Mongo case，驗證 `helm upgrade --install --wait` 能成功完成。\n- `make kind.deploy-observability-plane` 之 CI job 啟動 KinD → 部署 Greeter → 以 `kubectl port-forward` + `curl` 檢查 HyperDX `/api/health`。\n\n### End-to-End Testing\n- `test/e2e` 增加場景：部署 Greeter Service，發送自訂 log/trace，並透過 HyperDX API 查詢 (或 ClickHouse SQL) 驗證欄位 `k8s.namespace.name`/`service.name`。\n- 文件附錄手動驗證腳本（e.g. `scripts/verify-hyperdx.sh`）協助開發者在本機 Kind cluster 重複執行。\n",
  "fileStats": {
    "size": 9929,
    "lines": 172,
    "lastModified": "2025-11-14T14:38:08.674Z"
  },
  "comments": []
}