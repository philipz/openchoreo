{
  "id": "snapshot_1763130631637_bkcoqnyb0",
  "approvalId": "approval_1763130631617_23e4wg59i",
  "approvalTitle": "HyperDX enablement requirements",
  "version": 1,
  "timestamp": "2025-11-14T14:30:31.637Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nClickStack 的 HyperDX 體驗層需要在 OpenChoreo Observability Plane 中成為正式元件，讓使用者在 `docs/DeepWiki/Observability.md` 所描述的管線上，除了 ClickHouse 儲存層外，也能透過官方 Helm 流程（參考 ClickHouse Docs〈Helm | ClickStack Deployment〉）快速啟用完整 UI、OTLP collector 與 MongoDB 狀態服務。本需求文件界定在 OpenChoreo 原始碼樹 (Helm chart、hack/install 腳本、make recipe 以及操作文件) 中，如何以預設就緒的方式啟用 HyperDX，並與現有的 ClickStack schema、Greeter Service 等範例工作負載串接。\n\n## Alignment with Product Vision\n\n本功能支援 steering/product.md 所定義的 **HyperDX Experience Layer** 與 **OpenChoreo-native Integrations** 目標：讓平台工程團隊能以自助方式部署 HyperDX UI、對接現有 OTLP 收集器及 ClickHouse 儲存；同時讓 OpenChoreo 應用開發者可以在本地 KinD 或多叢集環境中，一鍵取得低延遲的跨 Logs/Traces 分析介面。此舉也回應了商業目標中的「提供產品化遷移路徑」與「降低 TCO」指標，因為 HyperDX UI 將跟隨 Observability Plane chart 一起部署、並透過文件指標，協助團隊在兩季內完成 ClickStack 化。\n\n## Requirements\n\n### Requirement 1\n\n**User Story:** 作為平台 SRE，我想透過 OpenChoreo Observability Plane Helm chart 啟用 HyperDX，藉此獲得官方 ClickStack Helm 文件列出的核心元件（HyperDX、ClickHouse、MongoDB、OTel collector），以便快速驗證 UI 與資料面服務是否協同運作。\n\n#### Acceptance Criteria\n\n1. WHEN 執行 `make kind.deploy-observability-plane hyperdx=on` 或等價 Helm install 指令 THEN Helm release SHALL 佈署 `Deployment/hyperdx`、`Service/hyperdx` 以及 `StatefulSet/hyperdx-mongodb` 並在 `kubectl get pods -n openchoreo-observability-plane` 中呈現 Ready。\n2. IF 平台已具備外部 ClickHouse 或 Mongo 實例 THEN values.yaml SHALL 允許營運人員以 `hyperdx.clickhouse.*` 與 `hyperdx.mongodb.*` override 現有連線設定、密碼與持久化策略。\n3. WHEN 使用 `kubectl port-forward svc/hyperdx 8080:3000` 並瀏覽 `http://localhost:8080` THEN HyperDX UI SHALL 可建立管理者帳號並自動產生 ClickStack 預設 ClickHouse data source。\n\n### Requirement 2\n\n**User Story:** 作為 OpenChoreo 應用開發者，我想要 Greeter Service 或任意透過 OTLP 發送的 telemetry，在 HyperDX UI 中可查詢 Logs/Metrics/Traces，並保有 docs/DeepWiki/Observability.md 定義的 Kubernetes metadata 豐富化能力。\n\n#### Acceptance Criteria\n\n1. WHEN Greeter Service 依官方 Getting Started 文件部署並透過 collector 導入資料 THEN HyperDX Logs、Traces 介面 SHALL 顯示具備 `k8s.namespace.name`、`service.name` 等欄位的事件，且查詢時間 < 1 秒 (24h 範圍)。\n2. IF OTLP Gateway、collector 或 ClickHouse 尚未就緒 THEN HyperDX SHALL 以 helm chart 的 `extraEnv` 或健康檢查呈現等候狀態，避免 observer pod 因無法連線既有 OpenSearch 而重啟。\n3. WHEN 使用者在 HyperDX 內建立 Alert 或 Live Tail 功能 THEN ClickStack collector SHALL 維持原生 OTLP 格式，不需修改應用程式程式碼即可擷取 payload。\n\n### Requirement 3\n\n**User Story:** 作為平台維運工程師，我需要清楚的部署/驗證文件與自動化腳本，確保在 KinD 與實體叢集上部署 HyperDX 時不會破壞現有 CoreDNS/CNI 設定，並能快速定位 Greeter 等範例服務的 Logs/Traces。\n\n#### Acceptance Criteria\n\n1. WHEN 依照更新後的 `docs/observability/clickstack.md`（或同等 README）步驟操作 THEN 使用者 SHALL 得到 `kind`、`hack/deploy-clickstack-kind.sh`、`kubectl port-forward`、`HyperDX UI onboarding` 等詳細流程，並包含 Greeter 範例如何驗證 Logs/Traces。\n2. IF 執行 `hack/deploy-clickstack-kind.sh` THEN 腳本 SHALL 不再刪除 CoreDNS、亦不變更已由 `install/dev/kind.sh` 調整的預設 CNI/kube-proxy，同時輸出 HyperDX endpoint、MongoDB URI 與 ClickHouse 狀態說明。\n3. WHEN 部署完成後開發者查詢 `kubectl logs deploy/hyperdx`、`kubectl logs deploy/clickstack-collector` THEN 文件 SHALL 指引如何過濾 Greeter namespace、匯出 sample trace、以及故障排除連線與認證設定。\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: Helm values 與腳本各自僅處理 HyperDX enablement，collector 與 observer 不互相混入部署邏輯。\n- **Modular Design**: HyperDX 相關 chart values 應以 `config/observability` 下獨立 overlay 呈現，腳本只載入必要環境變數。\n- **Dependency Management**: 與 ClickHouse/Mongo 之密碼、憑證採 Secrets 或 `helm install --set-file`，避免硬編碼。\n- **Clear Interfaces**: Observer/collector 對 HyperDX 僅透過 OTLP 與 HTTP endpoints，並保留 `backend=clickstack` 配置開關。\n\n### Performance\n- HyperDX + ClickStack 鏈路 SHALL 維持 ≤1s p95 查詢延遲（24 小時資料），並支援 ≥2M log events/sec ingest，如 steering/tech.md 既有目標。\n- 本地 KinD 部署 SHALL 在 8 CPU / 16 GB 設定內完成，Helm 等候時間 ≤15 分鐘。\n\n### Security\n- 所有新服務 SHALL 遵循 OTel/ClickStack TLS 與密碼管理；預設使用 auto-generated secrets 並於文件說明如何整合 OIDC。\n- 文檔需提醒使用者啟用 `hyperdx.auth.enabled`（或同等）並設定初始管理者憑證。\n\n### Reliability\n- 腳本與 Helm values SHALL 於失敗時輸出明確錯誤（例如 Mongo 連線失敗、ClickHouse DNS 未 resolvable），並支援 `helm upgrade --install --wait` 重複執行。\n- 觀察者 (observer) 健康檢查需在純 ClickStack 模式下無需聯絡 OpenSearch，以免陷入 CrashLoop。\n\n### Usability\n- 文件提供 `kubectl`, `make`, `helm` 指令範例與常見問題，並附錄 HyperDX UI navigation（Logs、Traces、Alerts、Dashboards）。\n- 使用者能在 10 分鐘內完成 port-forward、登入 UI、並看到 Greeter service 相關 telemetry 的 walkthrough。\n",
  "fileStats": {
    "size": 6133,
    "lines": 66,
    "lastModified": "2025-11-14T14:30:18.574Z"
  },
  "comments": []
}