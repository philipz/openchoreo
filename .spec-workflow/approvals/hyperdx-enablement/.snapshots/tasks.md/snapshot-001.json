{
  "id": "snapshot_1763131214597_ip4vvxfgi",
  "approvalId": "approval_1763131214587_lnxklkhn2",
  "approvalTitle": "HyperDX enablement tasks",
  "version": 1,
  "timestamp": "2025-11-14T14:40:14.597Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. 強化 HyperDX Helm 模組與 ClickHouse/Mongo 參數化\n  - Files: install/helm/openchoreo-observability-plane/values.yaml; templates/hyperdx-deployment.yaml; templates/_helpers.tpl\n  - 調整 HyperDX Deployment/Service 以符合 ClickHouse Docs Helm 參數 (env、replica、ingress)，補齊 `hyperdx.extraEnv`、Secrets 引用、initContainer 等，並支援自訂 ClickHouse/Mongo 連線與 API key。\n  - Purpose: 讓 Helm chart 預設即可部署 HyperDX UI，並可透過 overrides 指向既有 ClickHouse 或 Mongo。\n  - _Leverage: design.md (HyperDX Helm 模組); docs/DeepWiki/Observability.md pipeline; ClickStack Helm doc on env overrides_\n  - _Requirements: Requirement 1_\n  - _Prompt: Role: Helm/Kubernetes engineer熟悉 ClickStack/HyperDX chart | Task: 依 design.md 的 HyperDX 模組與 ClickHouse 官方 Helm 指南，擴充值檔/模板以支援 `hyperdx.enabled`, `hyperdx.extraEnv`, signing 參數、initContainer 等設定；確保 Secrets 與 ConfigMap 安全引用 | Restrictions: 僅動 Helm chart，遵循 `_helpers.tpl` labels，維持 minimal profile 相容 | Success: `helm template` 顯示 HyperDX Deployment/Service 正確套用參數，KinD 安裝後 pod Ready。\n\n- [ ] 2. 新增/整合 MongoDB for HyperDX state\n  - Files: install/helm/openchoreo-observability-plane/templates/hyperdx-mongodb*.yaml 或 charts/bitnami-mongodb/values; install/helm/.../values.yaml\n  - 依 ClickStack Helm 文件納入 MongoDB (Bitnami subchart 或 StatefulSet)，包含 Secret、自動密碼、PVC/persistence 以及 external Mongo 覆寫；並將 URI/env 注入 HyperDX。\n  - Purpose: 提供 HyperDX Alerts/Setting 所需 state backend，並允許在本地 KinD 與實際叢集間切換。\n  - _Leverage: design.md (MongoDB 附屬服務); install/dev/kind.sh storage 配置; ClickStack Helm doc Mongo requirement_\n  - _Requirements: Requirement 1_\n  - _Prompt: Role: Kubernetes stateful workload engineer | Task: 建立 `hyperdx.mongodb` values 結構 + Secrets + PVC，生成 `StatefulSet/Service` 或掛載 Bitnami subchart，並讓 HyperDX 透過 `MONGODB_URI` 連線 | Restrictions: 預設在 KinD 使用 ephemeral hostPath，但保留 storageClass override；不可刪改 coreDNS/CNI | Success: Helm 部署後 `hyperdx-mongodb-0` Ready，HyperDX 日誌顯示成功連線。\n\n- [ ] 3. 調整 OTLP collector + Gateway 流程供 HyperDX 查詢\n  - Files: config/observability/collectors/otel/base/collector-configmap.yaml; install/helm/openchoreo-observability-plane/templates/gateway*.yaml; values.yaml\n  - 擴展 logs pipeline 以保留 body/pod metadata，新增 traces/metrics pipeline、pod_association、OTLP exporter retries，確保 HyperDX UI 中能以 k8s 屬性查詢；同步更新 Gateway exporter endpoint 與 `hyperdx.extraEnv` (OTLP URLs)。\n  - Purpose: 讓 Greeter 等 workloads 產生的 telemetry 在 HyperDX 中可搜尋/追蹤。\n  - _Leverage: design.md (Collector 調整); docs/DeepWiki/Observability.md metadata 需求; ClickStack Helm doc OTel collector 範本_\n  - _Requirements: Requirement 2_\n  - _Prompt: Role: OpenTelemetry engineer | Task: 依 design.md 流程改寫 collector ConfigMap 與 Gateway exporter，保留 k8sattributes/attributes.promote，新增 traces+metrics pipeline 並確保 HTTP/gRPC 端點對 HyperDX/ClickStack 可用 | Restrictions: 不可移除現有 namespace 過濾；需確保資源需求在 KinD 可跑 | Success: `kubectl logs deploy/clickstack-collector` 顯示成功向 OTLP gateway 送資料，HyperDX 查到 Greeter logs/trace。\n\n- [ ] 4. 修正 Observer 健康檢查與 ClickStack-only 行為\n  - Files: internal/observer/service/healthcheck.go (或等效); cmd/observer/main.go; install/helm/openchoreo-observability-plane/templates/observer/observer-deployment.yaml\n  - 依 design.md 將 `/health` 判斷依 backend 切換，移除對 OpenSearch 的硬性依賴，並針對 HyperDX 簽章 URL (signing.key/baseUrl) 加入設定；確保 dualRead=false 時不需 OpenSearch。\n  - Purpose: 避免 observer pod 因 OpenSearch DNS 失敗而 CrashLoop，確保 HyperDX-only 部署穩定。\n  - _Leverage: design.md (Observer 模組); existing clickstack-observability-plane 實作; docs/DeepWiki/Observability.md observer 描述_\n  - _Requirements: Requirement 2_\n  - _Prompt: Role: Go observer service engineer | Task: 更新健康檢查/依賴注入邏輯，讓 ClickStack backend 不再觸發 OpenSearch 健康檢查，並支援 HyperDX signing env | Restrictions: 不可破壞 dual-read flag 行為；保持 API 相容 | Success: `kubectl logs deploy/observer` 無 OpenSearch lookup error，`/health` 在 ClickStack-only 模式通過。\n\n- [ ] 5. 更新 Kind 自動化腳本與 Make 目標\n  - Files: hack/deploy-clickstack-kind.sh; make/kind.mk; docs/observability-logging.md (scripts section)\n  - 調整腳本以保留 install/dev/kind.sh 既有 CNI/kube-proxy 停用，不再刪 CoreDNS；加入 HyperDX/Mongo 參數輸出、port-forward 提示、helm cache env，並支援 `HYPERDX_ENABLED=true` 預設；Make target 說明 HyperDX flags。\n  - Purpose: 使用者可在本機 KinD 一鍵部署 HyperDX，並避免 CoreDNS 問題。\n  - _Leverage: design.md (Automation component); docs/DeepWiki/Installation, Observability sections_\n  - _Requirements: Requirement 3_\n  - _Prompt: Role: DevEx engineer | Task: 依設計調整 `hack/deploy-clickstack-kind.sh` 與 `make kind.deploy-observability-plane`，提供清楚輸出 (HyperDX URL、Mongo URI、`kubectl port-forward` 指令) 並避免 CoreDNS 修改 | Restrictions: 不引入 sudo；相容現有 env vars | Success: 執行 make 後可在 15 分鐘內看到 HyperDX UI，CoreDNS pods 維持 Running。\n\n- [ ] 6. 擴充文件與 Runbook（部署、驗證、故障排除）\n  - Files: docs/observability-logging.md (或新 docs/observability/clickstack.md); README snippets; docs/DeepWiki/Observability.md 補充章節\n  - 更新文件，加入依 ClickStack Helm 指南啟用 HyperDX 的步驟、Kind/Helm 指令、Greeter telemetry 驗證 (Logs/Metrics/Traces)、HyperDX UI onboarding 與常見錯誤排解 (ClickHouse/Mongo/collector/observer)。\n  - Purpose: 確保使用者可依文件完成部署並找到監控資料。\n  - _Leverage: design.md (Docs component); ClickStack Helm doc sections (install, verify, port-forward); docs/DeepWiki 目錄架構_\n  - _Requirements: Requirement 3_\n  - _Prompt: Role: Technical writer/observability engineer | Task: 撰寫/更新 docs，涵蓋 make/kind 腳本、Helm overrides、port-forward、HyperDX UI 設定與 Greeter 驗證，並連結 DeepWiki 章節 | Restrictions: 中文文件需與現有風格一致，含命令範例 | Success: 文件步驟可被獨立遵循並於 HyperDX 找到 Greeter logs/traces。\n\n- [ ] 7. 測試與驗證（Helm、KinD、E2E）\n  - Files: install/helm/openchoreo-observability-plane/tests/test-migration.sh; test/e2e/*; scripts/verify-hyperdx.sh (新)\n  - 新增 Helm chart 單元測試案例 (enable HyperDX + Mongo)、在 E2E 測試中加入 Greeter -> HyperDX 流程，並提供腳本驗證 port-forward/查詢 API；確保 `@test/e2e` 在 ClickStack-only 模式通過。\n  - Purpose: 自動驗證 HyperDX enablement 的穩定性與回歸。\n  - _Leverage: design.md (Testing strategy); existing clickstack-observability-plane spec 測試框架_\n  - _Requirements: Requirement 1, Requirement 2, Requirement 3_\n  - _Prompt: Role: QA/observability E2E engineer | Task: 擴寫 Helm 測試腳本與 E2E suites，模擬整個部署與資料流，並提供快速檢查腳本 | Restrictions: 測試需可於 KinD 跑完；不得依賴外部雲端資源 | Success: `make test-e2e` 通過並輸出 HyperDX 查詢結果。\n",
  "fileStats": {
    "size": 7671,
    "lines": 58,
    "lastModified": "2025-11-14T14:40:07.408Z"
  },
  "comments": []
}