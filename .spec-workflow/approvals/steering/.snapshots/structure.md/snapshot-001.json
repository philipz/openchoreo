{
  "id": "snapshot_1763047584661_hyqtb80ff",
  "approvalId": "approval_1763047584656_uv3ya4rcm",
  "approvalTitle": "ClickStack structure doc",
  "version": 1,
  "timestamp": "2025-11-13T15:26:24.661Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n```\nopenchoreo/\n├── cmd/                    # CLI & control-plane entrypoints (choreoctl, observer, API)\n├── internal/               # Private modules (observers, collectors orchestration, controllers)\n│   ├── observer/           # OpenSearch-era services to be upgraded for ClickStack\n│   ├── planes/             # Plane-specific reconciliation logic\n│   └── telemetry/          # (New) ClickStack adapters, OTLP routing, schema tooling\n├── pkg/                    # Reusable libraries (config, auth, platform SDK)\n├── api/                    # Kubernetes CRD types (Projects, Components, Pipelines)\n├── config/                 # Helm/Kustomize manifests for managers, collectors, ClickStack\n├── install/                # Bootstrap scripts (KinD, Terraform samples)\n├── docs/                   # Architecture whitepapers, migration guides, diagrams\n├── samples/                # Example workloads & platform configs, including observability recipes\n├── make/                   # Modular makefiles (lint, golang, kube, helm, docker)\n├── .spec-workflow/         # Steering + spec docs, implementation logs\n└── tools/                  # Generators (helm-gen, licenser), developer utilities\n```\n- Observability plane artifacts (ClickStack schemas, collector charts, Grafana dashboards) live under `config/observability/` with overlays per environment.\n- Backstage plugins and frontend assets reside in `docs/portal/` (or future `/ui`) to keep UI code isolated from Go modules.\n\n## Naming Conventions\n### Files\n- **Go packages**: `lowercase` with no underscores (e.g., `internal/observer/service`).\n- **Helm charts / Kustomize overlays**: `kebab-case` directories (e.g., `clickstack-collector`).\n- **Backstage plugins**: `plugin-name` directories with `index.tsx`, `*-card.tsx`.\n- **Tests**: Go tests use `_test.go`; UI tests use `.test.tsx`.\n\n### Code\n- **Types/Structs**: `PascalCase` (`ComponentSpec`, `ClickStackConfig`).\n- **Functions/Methods**: `camelCase` (`buildIngestPipeline`, `NewCollectorChart`).\n- **Constants**: `UPPER_SNAKE_CASE` for package-scoped constants, `camelCase` for locals.\n- **Variables**: `camelCase` in Go, `camelCase`/`const` in TypeScript, `kebab-case` for YAML keys.\n\n## Import Patterns\n### Import Order\n1. Standard library\n2. Third-party deps (grouped by domain: Kubernetes, OpenTelemetry, ClickHouse, others)\n3. Internal packages (`github.com/openchoreo/openchoreo/...`)\n\nBackstage/TypeScript modules follow: React core → third-party UI libs → shared utilities → local components.\n\n### Module/Package Organization\n- Go modules under `cmd`, `internal`, and `pkg` use absolute imports from `github.com/openchoreo/openchoreo`.\n- Feature boundaries (e.g., `internal/telemetry/clickstack`) expose interfaces via `pkg/observability` to keep CLI/handlers decoupled from storage-specific logic.\n- Helm charts share `/charts/common` libraries for collectors; overlays import base charts via Kustomize `bases`.\n\n## Code Structure Patterns\n### Module/Class Organization\n```\n1. Imports\n2. Constants/config structs\n3. Interfaces\n4. Implementations\n5. Helper funcs\n6. init()/exports\n```\n\n### Function/Method Organization\n- Validate inputs + derive context\n- Core logic (query building, reconciler steps)\n- Error handling with wrapped context\n- Return typed responses/DTOs\n\n### File Organization Principles\n- One primary struct/handler per file when >200 LOC\n- Keep ClickStack-specific code in `telemetry/clickstack` to ease future backend swaps\n- Shared schemas (SQL templates, dashboards) stored as `.sql`/`.jsonnet` assets under `config/observability/assets`\n\n## Code Organization Principles\n1. **Plane Isolation**: Control plane, data plane agents, and observability plane code live in distinct packages to prevent accidental cross-dependencies.\n2. **Interface-first**: Observer APIs depend on `StorageProvider` interfaces so OpenSearch → ClickStack migration remains incremental.\n3. **Declarative Config**: Helm/Kustomize remains source of truth; Go code reads structured configs rather than embedding environment logic.\n4. **Spec Alignment**: Every new module documents requirements/design/tasks via `.spec-workflow` before implementation.\n\n## Module Boundaries\n- **Observer API ↔ Storage**: `internal/observer/service` consumes `pkg/telemetry/query` interfaces; implementations live in `internal/telemetry/{opensearch,clickstack}`.\n- **Collectors ↔ Control Plane**: Collectors (Helm charts) expose CRDs/values consumed by `pkg/planes/observability` reconciler.\n- **UI ↔ API**: Backstage plugins call Observer API; no direct ClickHouse credentials in UI code. Grafana dashboards interact via service accounts managed in `config/observability/iam`.\n- **Tenant Isolation**: Query policies enforced via ClickHouse row-level security definitions stored alongside schema migrations.\n\n## Code Size Guidelines\n- **Go files**: prefer <500 LOC; split packages when exceeding.\n- **Go functions**: keep under ~50 LOC; use helper funcs for query builders and reconciliation steps.\n- **TypeScript components**: <200 LOC per component; break cards/widgets into hooks + presentation.\n- **YAML manifests**: factor reusable snippets into `values.yaml`/`_helpers.tpl`.\n\n## Dashboard/Monitoring Structure\n```\nconfig/observability/\n├── clickstack/\n│   ├── charts/\n│   ├── values/\n│   └── schemas/          # SQL migrations & materialized views\n├── grafana/\n│   ├── dashboards/       # Jsonnet or JSON exports\n│   └── datasources/\n└── collectors/\n    ├── otel/             # OpenTelemetry Collector configs\n    └── fluent-bit/       # Legacy compatibility\n```\n- Dashboards version-controlled via Jsonnet + CI to render + lint before release.\n- Observer API exposes health/metrics endpoints scraped by Prometheus for self-monitoring.\n\n## Documentation Standards\n- Each plane/module owns a `README.md` describing purpose, inputs/outputs, deployment steps.\n- ClickStack schemas documented with ER diagrams and sample queries in `docs/observability`.\n- Runbooks (backup/restore, scaling) live in `docs/runbooks/`.\n- Inline comments reserved for non-obvious logic (e.g., ClickHouse optimizer hints).\n- Steering/spec documents updated per workflow; implementation logs recorded after each task.\n",
  "fileStats": {
    "size": 6409,
    "lines": 113,
    "lastModified": "2025-11-13T15:26:21.313Z"
  },
  "comments": []
}