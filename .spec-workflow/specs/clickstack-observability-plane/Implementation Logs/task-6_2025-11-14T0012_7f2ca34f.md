# Implementation Log: Task 6

**Summary:** Added ClickStack cost/health visibility via Grafana dashboards, Prometheus alerts/recording rules, and a CSV cost export API backed by ClickHouse.

**Timestamp:** 2025-11-14T00:12:56.034Z
**Log ID:** 7f2ca34f-5b90-4298-b7b0-3328465344e6

---

## Statistics

- **Lines Added:** +705
- **Lines Removed:** -62
- **Files Changed:** 12
- **Net Change:** 643

## Files Modified
- .spec-workflow/specs/clickstack-observability-plane/tasks.md
- cmd/observer/main.go
- install/helm/openchoreo-observability-plane/values.yaml
- internal/observer/handlers/handlers.go
- internal/observer/service/service.go
- pkg/telemetry/query/types.go
- internal/telemetry/clickstack/query_builder.go
- internal/telemetry/clickstack/provider.go

## Files Created
- config/observability/grafana/dashboards/clickstack-overview.json
- config/observability/grafana/dashboards/clickstack-cost-health.json
- install/helm/openchoreo-observability-plane/templates/monitoring/grafana-dashboards.yaml
- install/helm/openchoreo-observability-plane/templates/monitoring/prometheusrule.yaml

---

## Artifacts

### Components

#### GrafanaDashboards
- **Type:** Helm
- **Purpose:** Packages ClickStack overview and cost/health dashboards as ConfigMaps consumed by Grafana sidecars.
- **Location:** install/helm/openchoreo-observability-plane/templates/monitoring/grafana-dashboards.yaml
- **Props:** Files from config/observability/grafana/dashboards, labeled grafana_dashboard=1
- **Exports:** ConfigMap (per dashboard)

#### PrometheusRule
- **Type:** Helm
- **Purpose:** Recording and alerting rules for ingestion throughput, query latency, compression ratio, and cost estimation.
- **Location:** install/helm/openchoreo-observability-plane/templates/monitoring/prometheusrule.yaml
- **Props:** Recording rules for clickstack:ingest_logs_per_sec, storage/query cost plus alerts for lag/latency/compression
- **Exports:** PrometheusRule

### Functions

#### GenerateCostReportCSV
- **Purpose:** Aggregates ClickStack usage via storage provider and serializes rows into CSV for download.
- **Location:** internal/observer/service/service.go:174
- **Signature:** (ctx context.Context, params query.CostReportQuery) (string, error)
- **Exported:** Yes

#### CostReport
- **Purpose:** Builds ClickHouse SQL that summarizes log volume per tenant/project for billing windows.
- **Location:** internal/telemetry/clickstack/query_builder.go:190
- **Signature:** (params query.CostReportQuery) (string, []any, error)
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** New GET /api/costs/export endpoint retrieves aggregated usage from ClickStack via the telemetry storage provider and delivers CSV downloads for FinOps tooling.
- **Frontend Component:** internal/observer/handlers/handlers.go:383
- **Backend Endpoint:** clickstack Provider GetCostReport
- **Data Flow:** Request with ?month=YYYY-MM → service.GenerateCostReportCSV → ClickStack SQL aggregation → CSV returned to caller.

