# Implementation Log: Task 1

**Summary:** Introduced a telemetry storage interface plus a ClickStack-backed provider and SQL builder so the observer service can query ClickHouse with retries, TLS, and reusable query definitions.

**Timestamp:** 2025-11-13T16:02:24.940Z
**Log ID:** 42459ae0-e571-460e-97e9-708da2e6a932

---

## Statistics

- **Lines Added:** +1000
- **Lines Removed:** -3
- **Files Changed:** 8
- **Net Change:** 997

## Files Modified
- go.mod
- go.sum
- internal/observer/config/config.go

## Files Created
- pkg/telemetry/query/types.go
- internal/telemetry/clickstack/provider.go
- internal/telemetry/clickstack/query_builder.go
- internal/telemetry/clickstack/query_builder_test.go
- internal/telemetry/clickstack/tls.go

---

## Artifacts

### Functions

#### NewProvider
- **Purpose:** Constructs and pings a ClickStack provider with pooled connections and compression settings.
- **Location:** internal/telemetry/clickstack/provider.go:27
- **Signature:** (cfg config.ClickStackConfig, logger *slog.Logger) (*Provider, error)
- **Exported:** Yes

#### buildClickHouseOptions
- **Purpose:** Translates ClickStack config plus TLS settings into clickhouse.Options for connectivity.
- **Location:** internal/telemetry/clickstack/provider.go:72
- **Signature:** (cfg config.ClickStackConfig) (*clickhouse.Options, error)
- **Exported:** No

#### ComponentLogs
- **Purpose:** Builds the ClickHouse SQL statement and arguments for component log queries.
- **Location:** internal/telemetry/clickstack/query_builder.go:34
- **Signature:** (params query.ComponentLogQuery) (string, []any, error)
- **Exported:** Yes

#### ComponentTraces
- **Purpose:** Generates the ClickHouse SQL for trace retrieval with time window and limit enforcement.
- **Location:** internal/telemetry/clickstack/query_builder.go:122
- **Signature:** (params query.ComponentTraceQuery) (string, []any, error)
- **Exported:** Yes

### Classes

#### StorageProvider
- **Purpose:** Defines the contract for fetching logs and traces plus performing health checks regardless of the backing datastore.
- **Location:** pkg/telemetry/query/types.go
- **Methods:** GetComponentLogs, GetProjectLogs, GetGatewayLogs, GetOrganizationLogs, GetComponentTraces, HealthCheck
- **Exported:** Yes

#### Provider
- **Purpose:** Executes ClickHouse queries with TLS, retries, and scanning logic to return telemetry results from ClickStack.
- **Location:** internal/telemetry/clickstack/provider.go
- **Methods:** GetComponentLogs, GetProjectLogs, GetGatewayLogs, GetOrganizationLogs, GetComponentTraces, HealthCheck, Close
- **Exported:** Yes

#### QueryBuilder
- **Purpose:** Generates ClickHouse SQL for logs, traces, and specialized filters (components, projects, orgs, gateways).
- **Location:** internal/telemetry/clickstack/query_builder.go
- **Methods:** ComponentLogs, ProjectLogs, GatewayLogs, OrganizationLogs, ComponentTraces
- **Exported:** Yes

